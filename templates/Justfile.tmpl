# This file was initially generated by dredger, but feel free to adapt it to your needs and environment
set dotenv-load
program := `basename $PWD`
port := env_var_or_default("{{ upper ( snakecase .ModuleName ) }}_PORT_NB", "9090")

# Show this help page
help:
    just -l

# Update code of templ files
templ:
    templ generate web/pages/*.templ

# Build service
build: templ
	go mod tidy
	go build

# Install service locally
install: build
	go install

# Run service locally
run: build
    go run . -p {{"{{port}}"}}

# Run service locally in debug mode
debug: build
    go run . -d -p {{"{{port}}"}}

# Generate code from OpenAPI.yaml
generate:
	dredger generate OpenAPI.yaml -o . -f -n {{ .ModuleName }}

# Build SBOM files
sbom-build:
	GOARCH=amd64 GOOS=linux cyclonedx-gomod mod -licenses -json -output sbom.json

# Upload SBOM files
sbom: sbom-build
	curl -X "POST" "http://dependency-track-api.${DEPENDENCY_TRACK_SERVER}/api/v1/bom" \
		-H "Content-Type:multipart/form-data" \
		-H "X-Api-Key:${DEPENDENCY_TRACK}" \
		-F "projectName={{"{{program}}"}}/{{ .ModuleName }}" \
		-F "bom=@sbom.json"

docker-build:
	env GOOS=linux GOARCH=amd64 go build && \
	docker build -t {{ .ModuleName }} . && \
	rm -rf {{ .ModuleName }}

docker-run:
	docker run --rm -p {{ .Port }}:{{ .Port }} --env-file=.env {{ .ModuleName }}

# Install required tools
required:
    go install github.com/a-h/templ/cmd/templ@latest

# Update all required libraries
update: required
    go get -u
    go mod tidy

# List all ToDo items of the source code
todo:
    rg -ip "to.?do:"

# Push to git
push:
    git add .
    git commit -a
    git push

# Show changes for git
status:
    git status -s
