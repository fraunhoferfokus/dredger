// Don't edit this file, as it is generated by dredger
package subscribers

import (
	"{{ lcfirst ( camelcase .ModuleName ) }}/entities"
	"encoding/json"
	"log"

	"github.com/gorilla/websocket"
	"github.com/nats-io/nats.go"
)

{{- range .Operations }}
func {{ ucfirst ( camelcase .OperationName) }}(nc *nats.Conn, ws *websocket.Conn) *nats.Subscription {

	// Subscribe to "{{.ChannelName}}"
	Sub, err := nc.Subscribe("{{.ChannelName}}", func(msg *nats.Msg) {
		{{- range .Messages }}
			env{{ucfirst .MessageName}} := entities.Envelope{
				Type: "{{.MessageName}}",
				Data: msg.Data,
			}
			out{{ucfirst .MessageName}}, err := json.Marshal(env{{ucfirst .MessageName}})
			if err != nil {
				log.Println("Error marshaling {{.MessageName}} envelope:", err)
				return
			}
			if writeErr := ws.WriteMessage(websocket.TextMessage, out{{ucfirst .MessageName}}); writeErr != nil {
				log.Println("Error writing {{.MessageName}} to WebSocket:", writeErr)
			}
		{{ end }}
	})
	if err != nil {
		log.Println("NATS subscribe to {{.ChannelName}} failed:", err)
		return nil
	}

	return Sub
}
{{ end }}